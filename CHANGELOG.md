# Wizard's Choice - Changelog

## [Unreleased]

### Added
- Level-up spell selection screen with options from defeated enemy and random spells
- Spell improvement system for already known spells
- Experience gain based on difficulty (10x for easy, 25x for normal, 50x for hard)
- Card drawing at the beginning of each turn to refill player's hand
- Comprehensive process maps in Mermaid diagram format to visualize game architecture
- Restructured todo.md with a sequential implementation plan for remaining tasks
- Import standards documentation defining rules for absolute vs. relative imports
- Standardized import organization in main.js (alphabetical ordering)
- Split GameManager into modular components for better code organization:
  - GameStateManager - Handles overall game state and initialization
  - BattleManager - Manages battle flow and turn processing
  - PlayerManager - Handles player state and actions
- Split EnhancedUIManager into modular components for better separation of concerns:
  - ScreenManager - Handles screen transitions and visibility
  - UIElementManager - Manages UI element creation and updating
  - UIEventManager - Handles event handling for UI elements
- New modular spell system with separate SpellDefinitions, SpellHandManager, and SpellProgressionTracker
- New modular game management system with BattleManager, PlayerManager, and GameStateManager
- New modular UI system with ScreenManager, UIElementManager, and UIEventManager
- Implemented opponent spell hand management in EnhancedSpellSystem
  - Added `getOpponentSpellHand()` method to retrieve opponent's spells
  - Added `initializeOpponentSpellHand()` to dynamically create spell hands
  - Added `removeSpellFromOpponentHand()` to manage spell usage
  - Implemented `shuffleArray()` utility method for randomizing spell selection
- Comprehensive error handling infrastructure for game systems
  - Robust initialization checks
  - Detailed error logging and reporting
  - Graceful error recovery mechanisms
- Centralized ErrorHandler utility
  - Consistent error logging and tracking
  - User-friendly error notifications
  - Safe function execution with error recovery
  - Extensible error tracking infrastructure
- Done: Fixed player experience bar and level counter display in the UI overlay
  - Added robust error handling for missing UI elements
  - Added automatic recreation of missing overlay elements
  - Improved CSS styling for better visibility
  - Fixed calculation of experience points for current level
  - Fixed color display issues on health, mana, and experience bars
  - Removed incorrect XP label from inside the experience bar
  - Fixed experience counter to start from 0 with new games
  - Health and mana bars now properly update when spells are cast during battle
  - Fixed player-level element not being found in the DOM by adding automatic recreation
  - Enhanced overlay creation mechanisms to ensure all UI elements exist before use
  - Added additional fallback methods for updating health and mana values
  - **Fixed health and mana bars not updating when spells are cast by:**
    - Centralizing UI update logic in UIElementManager with consistent element IDs
    - Adding explicit fallback color styles to ensure bar visibility
    - Ensuring UI updates occur immediately after spell effects are applied
    - Simplifying the update chain to eliminate conflicting DOM manipulations
- **Fixed spell cards not appearing in battle scene by:**
  - Ensuring UI elements are created before showing battle screen
  - Adding direct spell button creation with appropriate styling
  - Implementing multiple fallback mechanisms for spell display
  - Fixing timing issues in the transition between screens
  - Fixed player-level element not being found in the DOM by adding robust creation logic
  - Enhanced overlay creation mechanisms to ensure all UI elements exist before use

### Changed
- Refactored project structure to remove duplicate files in src/js/core and src/js/ui
  - Consolidated all core game logic into src/game/core
  - Consolidated all UI components into src/game/ui
  - Updated imports to reference the canonical src/game paths
  - Added CSS style injection for more consistent UI rendering
  - Maintained all fixed methods including recordBattleResult in EnhancedSpellSystem
- Moved improveSpell method from EnhancedSpellSystem to SpellProgressionTracker for better code organization
- Updated React components to use GameStateManager instead of GameManager
- Consolidated duplicate initialization logic in SpellProgressionTracker.js
- Simplified resetPlayerProgress to reuse initPlayerProgress logic
- Added redirection from src/js/main.js to src/game/main.js for HTML compatibility
- Added redirection from src/js/ui files to their corresponding src/game/ui files
- Added placeholder spell card images via external URL
- Improved spell card layout with optimized space for descriptions and effects
  - Adjusted padding and margins to reduce wasted space
  - Set spell image width to 81% of card width for better proportions
  - Added text wrapping for descriptions to prevent clipping
  - Added support for both heal and healing attributes in effects display
  - Included tooltips for complete spell information on hover
- Updated import statements in main.js to follow the defined standards
- Verified all import statements in the codebase follow the defined standards
- Refactored EnhancedSpellSystem.js into modular components:
  - SpellDefinitions.js - spell catalog and attributes
  - SpellHandManager.js - deck and hand management
  - SpellProgressionTracker.js - player progression and spell unlocking
- Modified event listener attachment approach to use direct binding rather than node replacement
- Updated UI state management to be more resilient to DOM changes
- Enhanced spell selection visualization with improved feedback
- Exposed gameManager instance for debugging purposes
- Restructured main.js to use async initialization
- Reworked spell drawing from a static selection to a dynamic card game system
  - Player now draws cards from a deck that gets reshuffled when empty
  - Each spell can only exist in one place: hand, deck, or discard pile
  - Drawing system ensures variety in gameplay while preventing duplicates
- Improved opponent turn processing to mimic player mechanics
  - Opponent now maintains their own hand of 3 spells
  - Uses the same drawing and reshuffling mechanics as the player
- Refactored codebase to eliminate duplication between src/game/ and src/js/ directories
  - Consolidated main.js files, keeping the enhanced functionality from js version but placing it in game directory
  - Removed redundant js/main.js after consolidation
  - Updated imports to reference the canonical src/game paths
  - Added CSS style injection for more consistent UI rendering
  - Maintained all fixed methods including recordBattleResult in EnhancedSpellSystem
- Updated React components to use GameStateManager instead of GameManager
- Optimized large functions by breaking them into smaller, focused functions:
  - Refactored processOpponentTurn in BattleManager.js into multiple specialized methods
  - Split applySpellEffects into separate methods for different effect types (damage, healing, mana)
  - Extracted UI creation and styling logic into dedicated helper methods
  - Improved endBattle by creating separate victory and defeat handlers
  - Created specialized methods for spell option creation and handling in the level-up screen

### Updated
- Upgraded Next.js to the latest version to resolve version warning
- Improved dependency management to ensure latest stable versions

### Fixed
- Done: Fixed UI display issues with health, mana, and experience bars by correcting CSS path references in index.html
- Done: Updated main.js to correctly load styles from the proper 'styles' directory instead of 'css' directory
- Done: Ensured style tags are properly appended to document.head for consistent UI styling
- Done: Added explicit width attribute to health, mana, and experience fill elements to ensure proper display
- Done: Enhanced GameStateManager to explicitly call BattleManager.updatePlayerAndOpponentUI for consistent UI updates
- Fixed battle logic issue where enemy wizard wouldn't cast a spell after player's turn
  - Corrected spell ID mismatches in opponent spell initialization
  - Added validation in drawOpponentSpell to handle invalid spell IDs
  - Improved error handling in processOpponentTurn to ensure turn progression
  - Wrapped opponent turn logic in try/catch/finally to guarantee turn advancement
- Fixed turn counter not incrementing and player unable to cast spells after first turn
  - Added proper isProcessingTurn flag management in playerCastSpell and processOpponentTurn
  - Fixed initializeBattle to properly set up game state with correct turn counter
  - Ensured processTurnEnd is always called after opponent's turn
  - Added proper battle state tracking with isBattleOver flag
- Fixed player health and mana not updating correctly during gameplay
  - Enhanced applySpellEffects to properly update health and mana values
  - Added tracking of previous health values for animation effects
  - Improved UI update calls to ensure health and mana displays are refreshed
  - Added proper spell effect application for various spell types
  - Fixed checkBattleEnd to properly handle battle end conditions
- Fixed selected spells not appearing in battle
  - Removed code that overwrote player's spell selections
  - Added missing code to render the player's spell hand in the battle UI
  - Fixed mismatch between HTML element ID and UI manager's element reference in the battle scene
  - Fixed spell button layout to display horizontally in the battle UI using a flex container
  - Fixed spell selection not persisting to battle by updating resetAvailableSpells method
  - Fixed Stone Skin spell description displaying correctly with its healing effect
- Start Battle button now correctly responds to clicks after selecting spells
  - Fixed scope issues with selectedSpells and MAX_SELECTED_SPELLS variables
  - Improved event listener attachment to ensure clicks are properly detected
  - Added extensive debugging to trace button state changes
- Enhanced spell selection screen to properly track selected spells
- Fixed improper GameManager class export which was causing integration issues 
- Corrected EnhancedUIManager import in main.js to use default export
- Added comprehensive try/catch blocks to the battle initialization process
- Completely rebuilt the spell drawing system to work like a proper card game
  - Fixed issues with drawing duplicate spells or running out of spells
  - Implemented proper deck shuffling and discard pile mechanics
  - Added tracking of spells in hand vs. spells in deck
- Fixed enemy wizard mana consumption and damage application
  - Enemy now properly takes damage from player spells
  - Enemy's mana is correctly deducted when casting spells
- Fixed turn-based progression to ensure proper state management
- Fixed SceneManager rendering errors related to container dimensions
  - Added robust validation of container width and height
  - Implemented proper fallbacks for invalid dimensions
  - Added debugging for resize operations
- Fixed missing UI screens in the UIManager
  - Added 'spell-selection-screen' and 'results-screen' to managed screens list
  - Created missing 'results-screen' HTML element for battle outcome display
  - Fixed screen hiding and showing functionality
- Fixed accessibility issues in form elements
  - Added missing id and name attributes to select elements
  - Added proper label associations with for attributes
  - Improved form field structure in settings screen
  - Added colons to labels for better readability
- Fixed React component accessibility issues
  - Added proper label associations using htmlFor
  - Implemented focus states for better keyboard navigation
  - Standardized form field structure across HTML and React components
- Fixed "this.spellSystem.initPlayerSpells is not a function" error when starting a new game
  - Added missing initPlayerSpells method to EnhancedSpellSystem class
  - Method delegates to initializeSpellHand in SpellHandManager with player's unlocked spells
- Updated process_maps.md to accurately reflect the new modular spell system structure
  - Updated Component Structure diagram with correct component names
  - Updated Game Initialization Process diagram to show component initialization flow
  - Updated Spell System Process diagram to reflect the new modular architecture
- Fixed runtime errors related to missing methods in SpellSystem
- Fixed import paths to use the consolidated structure
- Fixed Spell Selection Bug where player's selected spells weren't properly preserved in battle
  - Removed code in GameStateManager.js that was overriding player's selected spells during battle initialization
  - Enhanced SpellHandManager.reshuffleDiscardPile to properly handle missing unlockedSpells parameter
  - Updated drawSpellFromDeck to correctly pass player's selected spells when reshuffling
  - Added additional logging to verify correct spells are being used throughout the battle
- Fixed Health/Mana Display Bug with improper value synchronization
  - Enhanced UIElementManager.updatePlayerInfo method to properly update all health/mana display elements
  - Enhanced UIElementManager.updateOpponentInfo method with the same improvements
  - Added data validation to ensure health and mana values are always integers
  - Added comprehensive logging to track updates to health and mana displays
  - Added additional checks to handle different UI element structures
- Fixed Card Drawing Bug that could lead to empty hands during battle
  - Enhanced SpellHandManager with deck state validation to prevent empty hands
  - Added emergency reshuffle mechanism when deck is running low
  - Implemented fallback for completely empty hands with basic spell addition
  - Added comprehensive spell tracking for better reshuffling
  - Improved validation of spell IDs to prevent invalid draws
  - Fixed issue with objects being incorrectly used as spell IDs instead of string IDs
- Fixed Progression System Issues
  - Added missing experience bar to player info UI
  - Restored proper XP display and tracking
  - Added CSS styling for experience bar with gold/yellow coloring
- Fixed experience bar display in player UI with proper green color and visual style
- Fixed health and mana bars to properly display with red and blue colors
- Fixed spells cast counter not updating during battles
- Improved level-up spell selection screen visibility and transitions
- Added proper battle info tracking including turn count and spells cast
- Restored UIFixer functionality to ensure proper display of health, mana, and experience bars
- Fixed health and mana bar display issues by ensuring proper styling is applied to UI elements
- Resolved TypeError in BattleManager when casting opponent spells
- Improved spell selection logic for opponents based on player level and AI difficulty
- Improved experience bar styling to match health and mana bars
  - Left-justified text with proper padding
  - Enhanced gold coloring for better visibility
  - Consistent styling with other UI elements
- Fixed runtime error in EnhancedSpellSystem
  - Added robust error handling for gameStateManager access
  - Implemented validation for game state and opponent
  - Added fallback values for critical parameters
  - Added comprehensive error logging
- Fixed player experience bar and level counter display in UI overlay:
  - Added robust error handling for missing UI elements
  - Automatic recreation of missing overlay elements 
  - Improved CSS styling for better visibility
  - Fixed calculation of experience points for current level
  - Fixed color display for health, mana, and experience bars
  - Removed incorrect XP label from inside experience bar
  - Ensured experience counter starts from 0 with new games
- Fixed health and mana bar updates when casting spells:
  - Added comprehensive UI update system to ensure consistent UI state
  - Ensured UI elements exist before applying spell effects
  - Improved debug logging for spell casting and health/mana changes
  - Fixed color gradients on health and mana bars
  - Centralized UI update logic to prevent inconsistent states

### Improved
- Enhanced error handling in BattleManager for opponent spell casting
  - Added comprehensive try-catch blocks
  - Improved error logging and reporting
  - Ensured UI updates even during error scenarios
- Added more robust initialization checks for spell system
- Enhanced opponent spell casting system
  - Dynamic spell hand generation
  - Intelligent spell selection based on difficulty
  - Improved error handling and logging
- Upgraded dependency management
  - Updated Next.js to latest version
  - Improved system initialization checks
- Enhanced error management across game systems
  - Standardized error logging format
  - Improved error visibility and debugging
  - Added mechanisms for graceful error recovery
- Enhanced player progress display in PlayerManager
  - Precise calculation of experience bar percentage
  - Improved health and mana bar updates
  - Added comprehensive logging for UI elements
  - Implemented dynamic experience calculation method
- Resolved UI rendering issues for experience, health, and mana bars
  - Corrected selector methods for bar elements
  - Added fallback error handling for missing UI elements
  - Improved percentage and text display accuracy
- Enhanced dynamic UI element creation in PlayerManager
  - Added multiple selector strategies for UI elements
  - Implemented fallback mechanism to create missing UI components
  - Improved error logging and element detection
  - Added robust handling for uninitialized game states
- Resolved experience bar rendering issues
  - Added dynamic element creation when UI components are missing
  - Improved error handling for UI initialization
  - Ensured graceful fallback when elements are not found
- Enhanced EnhancedSpellSystem robustness
  - Added dependency injection mechanism
  - Implemented comprehensive fallback spell generation
  - Added multiple layers of validation for spell hand creation
  - Improved error handling and logging

### Removed
- Eliminated redundant managers directory (src/js/managers)
  - Consolidated manager functionality into src/game/managers
  - Updated imports to reference the single source of manager classes
  - Removed outdated, less functional versions of manager classes
- Removed duplicate src/js/* directories after confirming all functionality is preserved in src/game/*
- Removed unused methods defineSpells() and addSpell() from EnhancedSpellSystem.js
- Removed commented-out audio functionality code from UIEventManager.js
- Removed SpellManager.js as its functionality is now handled by the modular spell system components (SpellDefinitions.js, SpellHandManager.js, and SpellProgressionTracker.js)
- Removed UIFixer.js and moved all health, mana, and experience bar styles to enhanced-style.css
- Simplified PlayerManager.updatePlayerProgressDisplay and BattleManager.updateHealthAndManaDisplay to only update values, not apply styles

## [1.0.0] - 2023-04-15

### Fixed
- Fixed experience bar not displaying under health and mana
- Fixed health and mana bars not filling with correct colors
- Fixed player and enemy wizard info display in UI
- Done: Fixed experience bar not appearing by adding a check for game UI visibility and dynamically creating the experience bar elements if they don't exist
- Done: Fixed CSS conflicts between style.css and enhanced-style.css by making selectors more specific and commenting out conflicting styles
- Done: Updated CSS for health, mana, and experience bars to ensure proper styling with visible colors and correct positioning
- Done: Fixed UI element selectors to properly target player and opponent health/mana bars using specific IDs
- Done: Fixed runtime error in GameStateManager by adding proper reference to UIElementManager and adding null checks for all manager references
- Done: Fixed health and mana bars not updating during battle by implementing direct DOM manipulation in BattleManager
- Done: Fixed visibility issues with health, mana, and experience bars by ensuring they are properly displayed and forcing repaints when needed
- Done: Fixed UIElementManager to directly set critical CSS properties for health, mana, and experience bars to ensure they display correctly
- Done: Added critical CSS styles directly to the main.js injected style tag with !important flags to ensure health, mana, and experience bars display properly

## [Unreleased]
## 2023-10-27
- Done: Applied consistent code style across all files in the codebase
  - Added JSDoc comment blocks for all methods in key files including GameStateManager.js, BattleManager.js, SpellDefinitions.js, PlayerManager.js, UIElementManager.js, SpellHandManager.js, ProgressionSystem.js, EnhancedSpellSystem.js, and SpellProgressionTracker.js
  - Standardized code organization with consistent formatting for imports, class definitions, and method declarations
  - Improved type documentation for properties and parameters to enhance code readability and maintainability

## [0.1.0] - 2025-03-21
Initial development version with core game functionality
